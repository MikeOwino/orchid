import 'dart:math';

import 'package:flutter/material.dart';
import 'package:orchid/api/configuration/orchid_user_config/orchid_user_config.dart';
import 'package:orchid/api/orchid_api.dart';
import 'package:orchid/api/orchid_platform.dart';
import 'package:orchid/api/preferences/observable_preference.dart';
import 'package:orchid/api/preferences/user_preferences.dart';
import 'package:flutter_gen/gen_l10n/app_localizations.dart';
import 'package:orchid/orchid/orchid_text.dart';
import 'package:orchid/orchid/orchid_text_field.dart';
import 'package:orchid/pages/circuit/config_change_dialogs.dart';
import 'package:orchid/pages/circuit/model/orchid_hop.dart';
import 'package:orchid/common/formatting.dart';
import 'package:orchid/common/page_tile.dart';
import 'package:orchid/common/screen_orientation.dart';
import 'package:orchid/common/titled_page_base.dart';

import '../app_routes.dart';
import '../../common/app_sizes.dart';

/// The main settings page.
class SettingsPage extends StatefulWidget {
  @override
  _SettingsPageState createState() => _SettingsPageState();
}

class _SettingsPageState extends State<SettingsPage> {
  var _defaultCurator = TextEditingController();

  // TODO: These switches should work directly with ObservablePreference
  bool _queryBalances = false;
  bool _showLogging = false;
  bool _tester = false;

  @override
  void initState() {
    super.initState();
    ScreenOrientation.all();
    initStateAsync();
    _defaultCurator.addListener(_curatorChanged);
  }

  void initStateAsync() async {
    _queryBalances = await UserPreferences().getQueryBalances();
    _defaultCurator.text = await UserPreferences().getDefaultCurator() ??
        OrchidHop.appDefaultCurator;

    advancedConfigChanged();
    setState(() {});
  }

  /// Update system config based on changes to user advanced config
  void advancedConfigChanged() async {
    var jsConfig = await OrchidUserConfig().getUserConfigJS();

    _showLogging = jsConfig.evalBoolDefault('logging', false);
    _tester = jsConfig.evalBoolDefault('tester', false);

    OrchidPlatform.pretendToBeAndroid =
        jsConfig.evalBoolDefault('isAndroid', false);

    setState(() {});
  }

  Widget build(BuildContext context) {
    var screenWidth = MediaQuery.of(context).size.width;
    var buttonStyle = OrchidText.button
        .copyWith(color: Colors.black, fontSize: 14, height: 1.5);

    var activeThumbColor = Color(0xFFFC7EFF);
    var activeTrackColor = Color(0x61FC7EFF);
    var inactiveThumbColor = Color(0x99FFFFFF);
    var inactiveTrackColor = Color(0x61FFFFFF);

    final height = 56.0;
    return TitledPage(
      title: s.settings,
      decoration: BoxDecoration(),
      child: SafeArea(
        child: SingleChildScrollView(
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.stretch,
            children: <Widget>[
              // Accounts
              _divided(PageTile(
                title: s.deletedHops,
                onTap: () async {
                  await Navigator.pushNamed(context, AppRoutes.accounts);
                },
              )),

              // Default curator
              _divided(PageTile(
                height: height,
                title: s.defaultCurator,
                trailing: Container(
                    width: min(275, screenWidth * 0.5),
                    child: OrchidTextField(
                      controller: _defaultCurator,
                      margin: EdgeInsets.zero,
                      padding: EdgeInsets.zero,
                    )),
              )),

              // Balance query
              _divided(PageTile(
                height: height,
                title: s.queryBalances,
                trailing: Switch(
                  activeColor: activeThumbColor,
                  activeTrackColor: activeTrackColor,

                  // TODO: Why aren't these working?
                  inactiveThumbColor: inactiveThumbColor,
                  inactiveTrackColor: inactiveTrackColor,

                  value: _queryBalances,
                  onChanged: (bool value) {
                    UserPreferences().setQueryBalances(value);
                    setState(() {
                      _queryBalances = value;
                    });
                  },
                ),
              )),

              // Advanced Configuration
              _divided(PageTile(
                height: height,
                title: s.advancedConfiguration,
                onTap: () async {
                  await Navigator.pushNamed(context, AppRoutes.configuration);
                  advancedConfigChanged(); // update anything that may have changed via config
                },
              )),

              // Manage Data
              _divided(PageTile.route(
                  // height: height,
                  title: s.configurationManagement,
                  routeName: '/settings/manage_config',
                  context: context)),

              // Logging
              if (_showLogging || _tester)
                _divided(PageTile.route(
                    // height: height,
                    title: s.logging,
                    routeName: '/settings/log',
                    context: context)),

              if (_tester)
                _divided(PageTile(
                  title: "(TEST) Reset First Launch",
                  trailing: RaisedButton(
                    child: Text(
                      s.reset.toUpperCase(),
                      style: buttonStyle,
                    ),
                    onPressed: () {
                      UserPreferences()
                          .releaseVersion
                          .set(ReleaseVersion.firstLaunch());
                    },
                  ),
                )),

              /*
              if (_tester)
                _divided(PageTile(
                  title: "(TEST) Reset V1 Account Data",
                  trailing: RaisedButton(
                    child: Text(s.reset.toUpperCase(), style: buttonStyle),
                    onPressed: () {
                      UserPreferences().activeAccounts.set([]);
                      UserPreferences().cachedDiscoveredAccounts.set({});
                    },
                  ),
                )),
               */
            ],
          ),
        ),
      ),
    );
  }

  Widget _divided(Widget child) {
    return Column(
      children: [
        pady(8),
        Divider(color: Color(0xffE9E7E7)),
        child,
      ],
    );
  }

  void _curatorChanged() {
    UserPreferences().setDefaultCurator(_defaultCurator.text);
  }

  @override
  void dispose() {
    super.dispose();
    ScreenOrientation.reset();
    _defaultCurator.removeListener(_curatorChanged);
  }

  S get s {
    return S.of(context);
  }
}
